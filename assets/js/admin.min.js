!function(t){"use strict";var e=[],s=[],a=null,i=null,l=!1;function n(e){var s=t('.stl-group-item[data-group="'+e+'"]'),a=s.filter(":checked"),i=s.length===a.length;t('.stl-select-group[data-group-id="'+e+'"]').prop("checked",i)}function d(){s=[];var e={};t(".stl-select-db.stl-group-item:checked").each((function(){var s=t(this).data("group");s&&(e[s]=!0)})),t(".stl-select-db:checked:not(.stl-group-item)").each((function(){try{var e=JSON.parse(t(this).val());s.push(e)}catch(e){console.error("Invalid JSON in checkbox value",t(this).val())}})),Object.keys(e).length>0&&t(".stl-group-item").each((function(){var a=t(this).data("group");if(a&&e[a])try{var i=JSON.parse(t(this).val());t(this).prop("checked")&&(i.group=a,s.push(i))}catch(e){console.error("Invalid JSON in checkbox value",t(this).val())}}))}function o(t,e){if(0===t)return"0 Bytes";var s=e||2,a=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,a)).toFixed(s))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][a]}function c(t){return null===t?"<em>NULL</em>":""===t?"<em>empty string</em>":String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;")}t((function(){!function(){var e=t(".stl-tabs");if(0===e.length)return;var s=e.find(".stl-tabs-nav a"),a=e.find(".stl-tab-content");s.first().addClass("active"),a.first().addClass("active"),s.on("click",(function(e){e.preventDefault();var i=t(this).attr("href");s.removeClass("active"),a.removeClass("active"),t(this).addClass("active"),t(i).addClass("active")}))}(),t("body").append('<div id="stl-file-diff-modal" class="stl-modal"><div class="stl-modal-content"><span class="stl-modal-close">&times;</span><h2 class="stl-modal-title"></h2><div class="stl-modal-body"></div></div></div>'),t("body").append('<div id="stl-db-diff-modal" class="stl-modal"><div class="stl-modal-content"><span class="stl-modal-close">&times;</span><h2 class="stl-modal-title"></h2><div class="stl-modal-body"></div></div></div>'),a=t("#stl-file-diff-modal"),i=t("#stl-db-diff-modal"),t(".stl-modal-close").on("click",(function(){t(this).closest(".stl-modal").hide()})),t(window).on("click",(function(e){t(e.target).hasClass("stl-modal")&&t(".stl-modal").hide()})),t(document).on("click",".stl-view-diff",(function(e){e.preventDefault();var s=t(this).data("file");a.find(".stl-modal-title").text("File Diff: "+s),a.find(".stl-modal-body").html('<div class="stl-loading"></div>'),a.show(),t.ajax({url:stl_admin.ajax_url,type:"POST",data:{action:"stl_get_file_diff",nonce:stl_admin.nonce,file:s},success:function(t){if(t.success)if(t.data.is_binary)if(t.data.is_image){var e='<div class="stl-image-comparison">';e+="<h3>Image Comparison</h3>",e+='<div class="stl-image-container">',e+='<div class="stl-image-side">',e+="<h4>Production Version</h4>",t.data.production_exists?(e+='<div class="stl-image-wrapper">',e+='<img src="'+t.data.production_url+'" alt="Production: '+t.data.file_name+'">',e+="</div>",e+="<p>File size: "+o(t.data.production_size)+"</p>"):e+='<div class="stl-image-missing">Image does not exist in production</div>',e+="</div>",e+='<div class="stl-image-side">',e+="<h4>Staging Version</h4>",t.data.staging_exists?(e+='<div class="stl-image-wrapper">',e+='<img src="'+t.data.staging_url+'" alt="Staging: '+t.data.file_name+'">',e+="</div>",e+="<p>File size: "+o(t.data.staging_size)+"</p>"):e+='<div class="stl-image-missing">Image does not exist in staging</div>',e+="</div>",e+="</div>",e+="</div>",a.find(".stl-modal-body").html(e),a.find(".stl-modal-content").addClass("stl-modal-wide")}else e='<div class="stl-binary-info">',e+="<p>This is a binary file. Diff cannot be displayed.</p>",t.data.staging_exists&&t.data.production_exists?(e+="<p>File exists in both staging and production environments.</p>",e+="<p>Staging file size: "+o(t.data.staging_size)+"</p>",e+="<p>Production file size: "+o(t.data.production_size)+"</p>"):t.data.staging_exists?(e+="<p>File exists only in staging environment.</p>",e+="<p>File size: "+o(t.data.staging_size)+"</p>"):(e+="<p>File exists only in production environment.</p>",e+="<p>File size: "+o(t.data.production_size)+"</p>"),e+="</div>",a.find(".stl-modal-body").html(e),a.find(".stl-modal-content").removeClass("stl-modal-wide");else a.find(".stl-modal-body").html('<div class="stl-diff">'+t.data.diff+"</div>"),a.find(".stl-modal-content").removeClass("stl-modal-wide");else a.find(".stl-modal-body").html('<div class="notice notice-error"><p>'+t.data.message+"</p></div>"),a.find(".stl-modal-content").removeClass("stl-modal-wide")},error:function(){a.find(".stl-modal-body").html('<div class="notice notice-error"><p>Error fetching file diff.</p></div>'),a.find(".stl-modal-content").removeClass("stl-modal-wide")}})})),t(document).on("click",".stl-view-db-diff",(function(e){e.preventDefault();var s=t(this).data("table"),a=t(this).data("id");i.find(".stl-modal-title").text("Database Diff: "+s+" (ID: "+a+")"),i.find(".stl-modal-body").html('<div class="stl-loading"></div>'),i.show(),t.ajax({url:stl_admin.ajax_url,type:"POST",data:{action:"stl_get_db_diff",nonce:stl_admin.nonce,table:s,id:a},success:function(t){if(t.success){var e="",s=t.data.entry_name?t.data.entry_name:"ID: "+t.data.id;if("added"===t.data.type){for(var a in e+='<div class="notice notice-success"><p>This is a new entry in the staging environment.</p></div>',e+="<p><strong>Entry: "+s+"</strong></p>",e+='<table class="stl-db-diff-table">',e+="<tr><th>Field</th><th>Value</th></tr>",t.data.diff.staging_data)e+="<tr>",e+='<td class="field-name">'+a+"</td>",e+="<td>"+c(t.data.diff.staging_data[a])+"</td>",e+="</tr>";e+="</table>"}else if("deleted"===t.data.type){for(var a in e+='<div class="notice notice-warning"><p>This entry has been deleted in the staging environment.</p></div>',e+="<p><strong>Entry: "+s+"</strong></p>",e+='<table class="stl-db-diff-table">',e+="<tr><th>Field</th><th>Value</th></tr>",t.data.diff.production_data)e+="<tr>",e+='<td class="field-name">'+a+"</td>",e+="<td>"+c(t.data.diff.production_data[a])+"</td>",e+="</tr>";e+="</table>"}else{for(var a in e+='<div class="notice notice-info"><p>This entry has been modified in the staging environment.</p></div>',e+="<p><strong>Entry: "+s+"</strong></p>",e+='<table class="stl-db-diff-table">',e+="<tr><th>Field</th><th>Production Value</th><th>Staging Value</th></tr>",t.data.diff.field_changes){var l=t.data.diff.field_changes[a];e+="<tr>",e+='<td class="field-name">'+a+"</td>",e+='<td class="production-value">'+c(l.production)+"</td>",e+='<td class="staging-value">'+c(l.staging)+"</td>",e+="</tr>"}e+="</table>"}i.find(".stl-modal-body").html(e)}else i.find(".stl-modal-body").html('<div class="notice notice-error"><p>'+t.data.message+"</p></div>")},error:function(){i.find(".stl-modal-body").html('<div class="notice notice-error"><p>Error fetching database diff.</p></div>')}})})),t("#stl-select-all-files").on("change",(function(){var s=t(this).prop("checked");t(".stl-select-file").prop("checked",s),e=[],s&&t(".stl-select-file:checked").each((function(){e.push(t(this).val())})),updateSyncButtonState()})),t(document).on("change",".stl-select-file",(function(){var s=t(this).val();if(t(this).prop("checked"))-1===e.indexOf(s)&&e.push(s);else{var a=e.indexOf(s);-1!==a&&e.splice(a,1),t("#stl-select-all-files").prop("checked",!1)}updateSyncButtonState()})),t("#stl-select-all-db").on("change",(function(){var e=t(this).prop("checked");t(".stl-select-db:not(.stl-group-item)").prop("checked",e),d(),updateSyncButtonState()})),t(document).on("change",".stl-select-all-table",(function(){var e=t(this).prop("checked"),s=t(this).data("table"),a=t(this).data("group");t('.stl-group-item[data-group="'+a+'"][data-table="'+s+'"]').prop("checked",e),d(),updateSyncButtonState(),n(a)})),t(document).on("change",".stl-select-group",(function(){var e=t(this).prop("checked"),s=t(this).data("group-id");t('.stl-group-item[data-group="'+s+'"]').prop("checked",e),t('.stl-select-all-table[data-group="'+s+'"]').prop("checked",e),d(),updateSyncButtonState()})),t(document).on("change",".stl-select-db",(function(){if(d(),updateSyncButtonState(),t(this).hasClass("stl-group-item")){var e=t(this).data("group");!function(e,s){var a=t('.stl-group-item[data-group="'+e+'"][data-table="'+s+'"]'),i=a.filter(":checked"),l=a.length===i.length;t('.stl-select-all-table[data-group="'+e+'"][data-table="'+s+'"]').prop("checked",l)}(e,t(this).data("table")),n(e)}else{var s=t(".stl-select-db:not(.stl-group-item)").length===t(".stl-select-db:not(.stl-group-item):checked").length;t("#stl-select-all-db").prop("checked",s)}})),t(document).on("click",".stl-toggle-group",(function(e){e.preventDefault();var s=t(this).data("group-id"),a=t("#group-content-"+s),i=t(this);a.is(":visible")?(a.slideUp(200),i.text(stl_admin.i18n.show_details||"Show Details")):(a.slideDown(200),i.text(stl_admin.i18n.hide_details||"Hide Details"))})),t("#stl-sync-selected").on("click",(function(){l||(0!==e.length||0!==s.length?confirm("Are you sure you want to sync the selected changes from staging to production? This action cannot be undone.")&&(l=!0,t(this).append('<span class="stl-loading"></span>'),t(this).prop("disabled",!0),t.ajax({url:stl_admin.ajax_url,type:"POST",data:{action:"stl_sync_changes",nonce:stl_admin.nonce,files:JSON.stringify(e),tables:JSON.stringify(s)},success:function(e){if(e.success){var s='<div class="notice notice-success is-dismissible"><p>Changes synced successfully!</p></div>';if(e.data.files.success&&Object.keys(e.data.files.success).length>0){for(var a in s+="<h3>File Sync Results</h3>",s+='<ul class="stl-success-list">',e.data.files.success)s+="<li><strong>"+a+":</strong> "+e.data.files.success[a]+"</li>";s+="</ul>"}if(e.data.files.error&&Object.keys(e.data.files.error).length>0){for(var a in s+="<h3>File Sync Errors</h3>",s+='<ul class="stl-error-list">',e.data.files.error)s+="<li><strong>"+a+":</strong> "+e.data.files.error[a]+"</li>";s+="</ul>"}if(e.data.db.success&&e.data.db.success.length>0){s+="<h3>Database Sync Results</h3>",s+='<ul class="stl-success-list">';for(var i=0;i<e.data.db.success.length;i++)s+="<li>"+e.data.db.success[i]+"</li>";s+="</ul>"}if(e.data.db.error&&e.data.db.error.length>0){for(s+="<h3>Database Sync Errors</h3>",s+='<ul class="stl-error-list">',i=0;i<e.data.db.error.length;i++)s+="<li>"+e.data.db.error[i]+"</li>";s+="</ul>"}s+='<p><a href="'+window.location.href+'" class="button button-primary">Refresh Page</a></p>',t("body").append('<div id="stl-sync-result-modal" class="stl-modal"><div class="stl-modal-content"><span class="stl-modal-close">&times;</span><h2 class="stl-modal-title">Sync Results</h2><div class="stl-modal-body">'+s+"</div></div></div>"),t("#stl-sync-result-modal").show(),t("#stl-sync-result-modal .stl-modal-close").on("click",(function(){window.location.reload()}))}else alert("Error syncing changes: "+e.data.message)},error:function(){alert("Error syncing changes. Please try again.")},complete:function(){l=!1,t("#stl-sync-selected .stl-loading").remove(),t("#stl-sync-selected").prop("disabled",!1)}})):alert("Please select at least one change to sync."))}))}))}(jQuery),jQuery(document).ready((function(){jQuery("a#create-staging").click((function(t){jQuery("#response").html(""),jQuery("a#create-staging").css({"pointer-events":"none",color:"lightgrey"}),jQuery("span.spinner-create-staging").addClass("is-active").css({float:"left",visibility:""});const e={action:"create_staging",nonce:stl.nonce};jQuery.post(ajaxurl,e,(function(t){t.error?jQuery("#response").html('<p style="color: red;">'+t.data.message+"</p>"):(jQuery("#response").html('<p style="color: green;">'+t.data.message+"</p>"),jQuery("span.spinner-create-staging").removeClass("is-active").css({float:"right",visibility:"none"}),jQuery("a#create-staging").css({"pointer-events":"unset",color:"#fff"}),setTimeout((function(){location.reload()}),5e3))}))}))}));
